<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Save simulations meta-data 2 &mdash; Mocafe 1.0.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Installation" href="../installation.html" />
    <link rel="prev" title="Angiogenesis 3D" href="angiogenesis_3d.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Mocafe
            <img src="../_static/200mocafe_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Demo Gallery</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction_to_fenics.html">A brief introduction to FEniCS</a></li>
<li class="toctree-l2"><a class="reference internal" href="prostate_cancer2d.html">Prostate cancer</a></li>
<li class="toctree-l2"><a class="reference internal" href="angiogenesis_2d.html">Angiogenesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="angiogenesis_2d.html#full-code">Full code</a></li>
<li class="toctree-l2"><a class="reference internal" href="prostate_cancer3d.html">Prostate cancer 3D</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiple_pc_simulations.html">Save simulations meta-data 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="angiogenesis_3d.html">Angiogenesis 3D</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Save simulations meta-data 2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-to-run-this-example-on-mocafe">How to run this example on Mocafe</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visualize-the-results-of-this-simulation">Visualize the results of this simulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#implementation">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#managing-multiple-simulations">Managing multiple simulations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#result">Result</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#experiment-reported-in-figure-2-of-the-original-paper">Experiment reported in Figure 2 of the original paper</a></li>
<li class="toctree-l4"><a class="reference internal" href="#experiment-reported-in-figure-3-of-the-original-paper">Experiment reported in Figure 3 of the original paper</a></li>
<li class="toctree-l4"><a class="reference internal" href="#experiment-reported-in-figure-4-of-the-original-paper">Experiment reported in Figure 4 of the original paper</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#full-code">Full code</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bib.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Mocafe</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Demo Gallery</a> &raquo;</li>
      <li>Save simulations meta-data 2</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/demo_doc/multiple_angiogenesis_simulations.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-demo-doc-multiple-angiogenesis-simulations-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="save-simulations-meta-data-2">
<span id="multiple-angio-demo"></span><span id="sphx-glr-demo-doc-multiple-angiogenesis-simulations-py"></span><h1>Save simulations meta-data 2<a class="headerlink" href="#save-simulations-meta-data-2" title="Permalink to this headline"></a></h1>
<p>Often phase field models are simulated using different parameters. However, managing different parameters values,
simulation outputs, and other meta-data might be not trivial and can lead to mistakes and repeated simulations.</p>
<p>For this reason Mocafe provides tool to make simulation management easier. To see this in action, we are going
to simulate the Angiogenesis models presented in <a class="reference internal" href="angiogenesis_2d.html#angiogenesis-2d-demo"><span class="std std-ref">this demo</span></a> for different parameters
values.</p>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#how-to-run-this-example-on-mocafe" id="id3">How to run this example on Mocafe</a></p></li>
<li><p><a class="reference internal" href="#visualize-the-results-of-this-simulation" id="id4">Visualize the results of this simulation</a></p>
<ul>
<li><p><a class="reference internal" href="#implementation" id="id5">Implementation</a></p></li>
<li><p><a class="reference internal" href="#managing-multiple-simulations" id="id6">Managing multiple simulations</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#result" id="id7">Result</a></p>
<ul>
<li><p><a class="reference internal" href="#experiment-reported-in-figure-2-of-the-original-paper" id="id8">Experiment reported in Figure 2 of the original paper</a></p></li>
<li><p><a class="reference internal" href="#experiment-reported-in-figure-3-of-the-original-paper" id="id9">Experiment reported in Figure 3 of the original paper</a></p></li>
<li><p><a class="reference internal" href="#experiment-reported-in-figure-4-of-the-original-paper" id="id10">Experiment reported in Figure 4 of the original paper</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#full-code" id="id11">Full code</a></p></li>
</ul>
</div>
<section id="how-to-run-this-example-on-mocafe">
<h2><a class="toc-backref" href="#id3">How to run this example on Mocafe</a><a class="headerlink" href="#how-to-run-this-example-on-mocafe" title="Permalink to this headline"></a></h2>
<p>Make sure you have FEniCS and Mocafe installed and download the source script of this page (see above for the link).
Then, simply run it using python:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">python3 multiple_angiogenesis_simulations.py</span>
</pre></div>
</div>
<p>However, it is recommended to exploit parallelization to save simulation time:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mpirun -n 4 python3 multiple_angiogenesis_simulations.py</span>
</pre></div>
</div>
<p>Notice that the number following the <code class="docutils literal notranslate"><span class="pre">-n</span></code> option is the number of MPI processes you using for parallelizing the
simulation. You can change it accordingly with your CPU.</p>
</section>
<section id="visualize-the-results-of-this-simulation">
<h2><a class="toc-backref" href="#id4">Visualize the results of this simulation</a><a class="headerlink" href="#visualize-the-results-of-this-simulation" title="Permalink to this headline"></a></h2>
<p>You need to have <a class="reference external" href="https://www.paraview.org/">Paraview</a> to visualize the results. Once you have installed it,
you can easly import the <code class="docutils literal notranslate"><span class="pre">.xdmf</span></code> files generated during the simulation and visualize the result.</p>
<section id="implementation">
<h3><a class="toc-backref" href="#id5">Implementation</a><a class="headerlink" href="#implementation" title="Permalink to this headline"></a></h3>
<p>The simulated model is the same of the <a class="reference internal" href="angiogenesis_2d.html#angiogenesis-2d-demo"><span class="std std-ref">Angiogenesis 2D demo</span></a>, so most of
the code would be just the same. Thus, we created a convenience method that will do most of the work
for us, called <code class="docutils literal notranslate"><span class="pre">run_angiogenesis_simulation</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_angiogenesis_simulation</span><span class="p">(</span><span class="n">loading_message</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">)</span>
   <span class="o">...</span>
</pre></div>
</div>
<p>This method contains basically an adapted version of the code we saw in
<a class="reference internal" href="angiogenesis_2d.html#angiogenesis-2d-demo"><span class="std std-ref">Angiogenesis 2D demo</span></a> and thus we skip a full explanation in this demo.
Still, you can see the complete implementation in the <a class="reference internal" href="#multiple-angiogenesis-demo-full-code"><span class="std std-ref">Full Code</span></a> section.</p>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">run_angiogenesis_simulation</span></code> takes just three arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">loading_message</span></code>: just a string containing a message to display nearby the progress bar</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">parameters</span></code>: the simulation parameters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data_folder</span></code>: the folder to store the simulation output</p></li>
</ul>
</section>
<section id="managing-multiple-simulations">
<h3><a class="toc-backref" href="#id6">Managing multiple simulations</a><a class="headerlink" href="#managing-multiple-simulations" title="Permalink to this headline"></a></h3>
<p>In the Angiogenesis model original paper <span id="id1">[<a class="reference internal" href="../bib.html#id7" title="Rui D.M. Travasso, Eugenia Corvera Poiré, Mario Castro, Juan Carlos Rodrguez-Manzaneque, and A. Hernández-Machado. Tumor angiogenesis and vascular patterning: A mathematical model. PLoS ONE, 6(5):e19989, 2011. URL: http://www.fct.mctes.pt http://www.gulbenkian.pt/ http://www.conacyt.mx/ http://www.isciii.es/ http://www.micinn.es/, doi:10.1371/journal.pone.0019989.">TPoireC+11</a>]</span> they simulated the model for several conditions, which
are carefully reported in the paper figures:</p>
<ul class="simple">
<li><p>In Fig. 2 the authors show the model simulation result changing the parameter <span class="math notranslate nohighlight">\(\chi\)</span>, which influences the
tip cell velocity.</p></li>
<li><p>In Fig. 3 the authors show the model simulation result changing the parameter <span class="math notranslate nohighlight">\(\alpha_p\)</span>, which influences the
proliferation rate of the endothelial cells.</p></li>
<li><p>In Fig. 4 the authors show the model simulation result changing the parameter <span class="math notranslate nohighlight">\(T_s\)</span>, which influences the
angiogenic factor production</p></li>
</ul>
<p>Now that we defined the <code class="docutils literal notranslate"><span class="pre">run_angiogenesis_simulation</span></code> is very easy to do the same in Mocafe. We can simply use the
parameters file available at <a class="reference download internal" download="" href="../_downloads/6131c614d7c7b7316338d040d69f499b/parameters.ods"><code class="xref download docutils literal notranslate"><span class="pre">this</span> <span class="pre">link</span></code></a>, which contains a set of
parameters value derived from the original publication, and then change the desired value when needed.</p>
<p>First, wre load the parameters (be sure you refer to the correct file position in your file system):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parameters_file</span> <span class="o">=</span> <span class="n">file_folder</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;demo_in/angiogenesis_2d/parameters.ods&quot;</span><span class="p">)</span>
<span class="n">std_parameters</span> <span class="o">=</span> <span class="n">mpar</span><span class="o">.</span><span class="n">from_ods_sheet</span><span class="p">(</span><span class="n">parameters_file</span><span class="p">,</span> <span class="s2">&quot;SimParams&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, we define all the testing conditions we need as dictionaries. Notice that doing so we are also able to provide
a name and a description to each simulated condition.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_conditions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sim2C&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig2C&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 2C. The change in the &#39;chi&#39; parameter leads &quot;</span>
                <span class="s2">&quot;to a reduction of the tip cell velocity.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;chi&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;chi&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sim2D&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig2D&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 2D. The tip cell velocity is normal.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;chi&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;chi&quot;</span><span class="p">)}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sim3C&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig3C&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 3C. The proliferation rate is low.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;alpha_p&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;alpha_p&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                 <span class="s2">&quot;chi&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;chi&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.625</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sim3D&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig3D&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 3D. The proliferation rate is high.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;alpha_p&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;alpha_p&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.34</span><span class="p">,</span>
                                 <span class="s2">&quot;chi&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;chi&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.625</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sim4C&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig4C&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 4C. The angiogenic factor production is low&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;T_s&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sim4D&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig4D&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 4D. The angiogenic factor production is high.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;T_s&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, we use a for loop to simulate all the conditions defined in the dictionary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">sim_dict_key</span> <span class="ow">in</span> <span class="n">test_conditions</span><span class="p">:</span>
     <span class="c1"># get dictionary for simulation</span>
     <span class="n">sim_dict</span> <span class="o">=</span> <span class="n">test_conditions</span><span class="p">[</span><span class="n">sim_dict_key</span><span class="p">]</span>

     <span class="c1"># set data folder for current simulation</span>
     <span class="n">data_folder</span> <span class="o">=</span> <span class="n">mansimd</span><span class="o">.</span><span class="n">setup_data_folder</span><span class="p">(</span>
           <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;{file_folder / Path(&#39;demo_out&#39;)}/multiple_angiogenesis_simulations&quot;</span><span class="p">,</span>
           <span class="n">auto_enumerate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

     <span class="c1"># load standard parameters value</span>
     <span class="n">std_parameters</span> <span class="o">=</span> <span class="n">mpar</span><span class="o">.</span><span class="n">from_ods_sheet</span><span class="p">(</span><span class="n">parameters_file</span><span class="p">,</span> <span class="s2">&quot;SimParams&quot;</span><span class="p">)</span>
     <span class="c1"># and change the parameter according to the simulation</span>
     <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;parameters_to_change&quot;</span><span class="p">]:</span>
           <span class="n">std_parameters</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">param</span><span class="p">,</span>
                                    <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;parameters_to_change&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">])</span>

     <span class="c1"># run simulation measuring execution time</span>
     <span class="n">error_message</span> <span class="o">=</span> <span class="kc">None</span>
     <span class="k">try</span><span class="p">:</span>
           <span class="n">init_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
           <span class="n">run_angiogenesis_simulation</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;simulating </span><span class="si">{test_conditions[sim_dict_key][&#39;name&#39;]}</span><span class="s2">&quot;</span><span class="p">,</span>
                                       <span class="n">std_parameters</span><span class="p">,</span>
                                       <span class="n">data_folder</span><span class="p">)</span>
           <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">init_time</span>
     <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
           <span class="n">execution_time</span> <span class="o">=</span> <span class="kc">None</span>
           <span class="n">error_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

     <span class="c1"># store simulation meta-data</span>
     <span class="n">mansimd</span><span class="o">.</span><span class="n">save_sim_info</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span>
                           <span class="n">parameters</span><span class="o">=</span><span class="n">std_parameters</span><span class="p">,</span>
                           <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
                           <span class="n">sim_name</span><span class="o">=</span><span class="n">test_conditions</span><span class="p">[</span><span class="n">sim_dict_key</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                           <span class="n">sim_description</span><span class="o">=</span><span class="n">test_conditions</span><span class="p">[</span><span class="n">sim_dict_key</span><span class="p">][</span><span class="s1">&#39;desc&#39;</span><span class="p">],</span>
                           <span class="n">error_msg</span><span class="o">=</span><span class="n">error_message</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="result">
<h2><a class="toc-backref" href="#id7">Result</a><a class="headerlink" href="#result" title="Permalink to this headline"></a></h2>
<p>here you can find the screenshots of the results for each simulation compared with the original results reported
by Travasso et al. <span id="id2">[<a class="reference internal" href="../bib.html#id7" title="Rui D.M. Travasso, Eugenia Corvera Poiré, Mario Castro, Juan Carlos Rodrguez-Manzaneque, and A. Hernández-Machado. Tumor angiogenesis and vascular patterning: A mathematical model. PLoS ONE, 6(5):e19989, 2011. URL: http://www.fct.mctes.pt http://www.gulbenkian.pt/ http://www.conacyt.mx/ http://www.isciii.es/ http://www.micinn.es/, doi:10.1371/journal.pone.0019989.">TPoireC+11</a>]</span>.</p>
<section id="experiment-reported-in-figure-2-of-the-original-paper">
<h3><a class="toc-backref" href="#id8">Experiment reported in Figure 2 of the original paper</a><a class="headerlink" href="#experiment-reported-in-figure-2-of-the-original-paper" title="Permalink to this headline"></a></h3>
<p>A lower value of the <span class="math notranslate nohighlight">\(\chi\)</span> parameter lead to a lower tip cell velocity, and thus to thicker and less developed
vessels. This is clearly visible in the original publication comparing Fig 2C, which is the models simulated with a
low <span class="math notranslate nohighlight">\(\chi\)</span> value, with Fig 2D, where the <span class="math notranslate nohighlight">\(\chi\)</span> value is normal. Below you can find a crop of the image
reported in the original publication:</p>
<a class="reference internal image-reference" href="../_images/TravassoFig2_original.png"><img alt="../_images/TravassoFig2_original.png" src="../_images/TravassoFig2_original.png" style="width: 600px;" /></a>
<p>And here is the result with Mocafe (i.e. with the script reported on this page):</p>
<a class="reference internal image-reference" href="../_images/TravassoFig2.png"><img alt="../_images/TravassoFig2.png" src="../_images/TravassoFig2.png" style="width: 600px;" /></a>
<p>Notice that, even though the result is not exactly the same, the qualitative aspects are preserved. The possible
reasons for the differences in the results are many:</p>
<ul class="simple">
<li><p>not all parameters value are reported in the original publication (e.g. the number of angiogenic factor sources)</p></li>
<li><p>the position of the angiogenic factor sources and of the tip cells is random</p></li>
</ul>
</section>
<section id="experiment-reported-in-figure-3-of-the-original-paper">
<h3><a class="toc-backref" href="#id9">Experiment reported in Figure 3 of the original paper</a><a class="headerlink" href="#experiment-reported-in-figure-3-of-the-original-paper" title="Permalink to this headline"></a></h3>
<p>A difference in the proliferation rate of the endothelial cells can lead to thicker or thinner vessels. This is shown
in Figure 3 of the original publication, where they compared a simulation with a low proliferation rate (3C) and
a simulation with an high proliferation rate. Below you can find a crop of the image reported in
the original publication:</p>
<a class="reference internal image-reference" href="../_images/TravassoFig3_original.png"><img alt="../_images/TravassoFig3_original.png" src="../_images/TravassoFig3_original.png" style="width: 600px;" /></a>
<p>And here is the result with Mocafe (i.e. with the script reported on this page):</p>
<a class="reference internal image-reference" href="../_images/TravassoFig3.png"><img alt="../_images/TravassoFig3.png" src="../_images/TravassoFig3.png" style="width: 600px;" /></a>
<p>Notice that, even though the result is not exactly the same, the qualitative aspects are preserved. The possible
reasons for the differences in the results are many:</p>
<ul class="simple">
<li><p>not all parameters value are reported in the original publication (e.g. the number of angiogenic factor sources)</p></li>
<li><p>the position of the angiogenic factor sources and of the tip cells is random</p></li>
</ul>
</section>
<section id="experiment-reported-in-figure-4-of-the-original-paper">
<h3><a class="toc-backref" href="#id10">Experiment reported in Figure 4 of the original paper</a><a class="headerlink" href="#experiment-reported-in-figure-4-of-the-original-paper" title="Permalink to this headline"></a></h3>
<p>A difference in the angiogenic factor production by the sources can lead to a sparser or denser network of
blood vessels. This is shown in Figure 4 of the original publication, where they compared a simulation with low
angiogenic factor production (4C) with a simulation with high angiogenic factor production (4D).
Below you can find a crop of the image reported in the original publication:</p>
<a class="reference internal image-reference" href="../_images/TravassoFig4_original.png"><img alt="../_images/TravassoFig4_original.png" src="../_images/TravassoFig4_original.png" style="width: 600px;" /></a>
<p>And here is the result with Mocafe (i.e. with the script reported on this page):</p>
<a class="reference internal image-reference" href="../_images/TravassoFig4.png"><img alt="../_images/TravassoFig4.png" src="../_images/TravassoFig4.png" style="width: 600px;" /></a>
<p>In Mocafe the difference is less evident than the one evidenced in the original publication. Still, the blood
vessels network reported on the right looks slightly denser than the one on the left. The differences we observe
in respect with the original publication are probably due to the number of angiogenic factor sources, that was not
reported in the original publication and it is critical for this simulation in particular.</p>
</section>
</section>
<section id="full-code">
<span id="multiple-angiogenesis-demo-full-code"></span><h2><a class="toc-backref" href="#id11">Full code</a><a class="headerlink" href="#full-code" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fenics</span>
<span class="kn">import</span> <span class="nn">mshr</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">mocafe.fenut.fenut</span> <span class="k">as</span> <span class="nn">fu</span>
<span class="kn">import</span> <span class="nn">mocafe.fenut.mansimdata</span> <span class="k">as</span> <span class="nn">mansimd</span>
<span class="kn">from</span> <span class="nn">mocafe.angie</span> <span class="kn">import</span> <span class="n">af_sourcing</span><span class="p">,</span> <span class="n">tipcells</span>
<span class="kn">from</span> <span class="nn">mocafe.angie.forms</span> <span class="kn">import</span> <span class="n">angiogenesis_form</span><span class="p">,</span> <span class="n">angiogenic_factor_form</span>
<span class="kn">import</span> <span class="nn">mocafe.fenut.parameters</span> <span class="k">as</span> <span class="nn">mpar</span>

<span class="c1"># setup MPI</span>
<span class="n">comm</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">comm_world</span>
<span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
<span class="c1"># only process 0 logs</span>
<span class="n">fenics</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;std_out_all_processes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># set log level ERROR</span>
<span class="n">fenics</span><span class="o">.</span><span class="n">set_log_level</span><span class="p">(</span><span class="n">fenics</span><span class="o">.</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="c1"># get current folder</span>
<span class="n">file_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

<span class="c1"># define convenience method</span>
<span class="k">def</span> <span class="nf">run_angiogenesis_simulation</span><span class="p">(</span><span class="n">loading_message</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">):</span>
    <span class="c1"># define xdmf files</span>
    <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;af&quot;</span><span class="p">,</span> <span class="s2">&quot;tipcells&quot;</span><span class="p">]</span>
    <span class="n">file_c</span><span class="p">,</span> <span class="n">file_af</span><span class="p">,</span> <span class="n">tipcells_xdmf</span> <span class="o">=</span> <span class="n">fu</span><span class="o">.</span><span class="n">setup_xdmf_files</span><span class="p">(</span><span class="n">file_names</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">)</span>

    <span class="c1"># setup mesh</span>
    <span class="n">Lx</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;Lx&quot;</span><span class="p">)</span>
    <span class="n">Ly</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;Ly&quot;</span><span class="p">)</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;nx&quot;</span><span class="p">))</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;ny&quot;</span><span class="p">))</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">RectangleMesh</span><span class="p">(</span><span class="n">fenics</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                                <span class="n">fenics</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="p">),</span>
                                <span class="n">nx</span><span class="p">,</span>
                                <span class="n">ny</span><span class="p">)</span>


    <span class="c1"># define function space for c and af</span>
    <span class="n">function_space</span> <span class="o">=</span> <span class="n">fu</span><span class="o">.</span><span class="n">get_mixed_function_space</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># define function space for grad_T</span>
    <span class="n">grad_af_function_space</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">VectorFunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


    <span class="n">initial_vessel_width</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;initial_vessel_width&quot;</span><span class="p">)</span>

    <span class="n">c_0_exp</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="s2">&quot;(x[0] &lt; i_v_w) ? 1 : -1&quot;</span><span class="p">,</span>
                                <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                <span class="n">i_v_w</span><span class="o">=</span><span class="n">initial_vessel_width</span><span class="p">)</span>
    <span class="n">c_0</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">c_0_exp</span><span class="p">,</span> <span class="n">function_space</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">())</span>

    <span class="n">mu_0</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">fenics</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span> <span class="n">function_space</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">())</span>

    <span class="n">n_sources</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;n_sources&quot;</span><span class="p">))</span>

    <span class="n">random_sources_domain</span> <span class="o">=</span> <span class="n">mshr</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">fenics</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">initial_vessel_width</span> <span class="o">+</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
                                           <span class="n">fenics</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="p">))</span>

    <span class="n">sources_map</span> <span class="o">=</span> <span class="n">af_sourcing</span><span class="o">.</span><span class="n">RandomSourceMap</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span>
                                              <span class="n">n_sources</span><span class="p">,</span>
                                              <span class="n">parameters</span><span class="p">,</span>
                                              <span class="n">where</span><span class="o">=</span><span class="n">random_sources_domain</span><span class="p">)</span>

    <span class="n">sources_manager</span> <span class="o">=</span> <span class="n">af_sourcing</span><span class="o">.</span><span class="n">SourcesManager</span><span class="p">(</span><span class="n">sources_map</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

    <span class="n">af_0</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">fenics</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span> <span class="n">function_space</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">())</span>

    <span class="n">sources_manager</span><span class="o">.</span><span class="n">apply_sources</span><span class="p">(</span><span class="n">af_0</span><span class="p">)</span>

    <span class="n">file_af</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">af_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">file_c</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


    <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">TestFunctions</span><span class="p">(</span><span class="n">function_space</span><span class="p">)</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">function_space</span><span class="p">)</span>
    <span class="n">af</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

    <span class="n">grad_af</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">grad_af_function_space</span><span class="p">)</span>
    <span class="n">tipcells_field</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">function_space</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">())</span>

    <span class="n">grad_af</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>  <span class="c1"># assign to grad_af</span>
        <span class="n">fenics</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">fenics</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">af_0</span><span class="p">),</span> <span class="n">grad_af_function_space</span><span class="p">)</span>  <span class="c1"># the projection on the fun space of grad(af_0)</span>
    <span class="p">)</span>

    <span class="n">form_af</span> <span class="o">=</span> <span class="n">angiogenic_factor_form</span><span class="p">(</span><span class="n">af</span><span class="p">,</span> <span class="n">af_0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

    <span class="n">form_ang</span> <span class="o">=</span> <span class="n">angiogenesis_form</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c_0</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">mu_0</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

    <span class="n">weak_form</span> <span class="o">=</span> <span class="n">form_af</span> <span class="o">+</span> <span class="n">form_ang</span>

    <span class="n">tip_cell_manager</span> <span class="o">=</span> <span class="n">tipcells</span><span class="o">.</span><span class="n">TipCellManager</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span>
                                               <span class="n">parameters</span><span class="p">)</span>

    <span class="n">jacobian</span> <span class="o">=</span> <span class="n">fenics</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">weak_form</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">n_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;n_steps&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;angiogenesis_2d&quot;</span><span class="p">)</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">loading_message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># update time</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">)</span>

        <span class="c1"># turn off near sources</span>
        <span class="n">sources_manager</span><span class="o">.</span><span class="n">remove_sources_near_vessels</span><span class="p">(</span><span class="n">c_0</span><span class="p">)</span>

        <span class="c1"># activate tip cell</span>
        <span class="n">tip_cell_manager</span><span class="o">.</span><span class="n">activate_tip_cell</span><span class="p">(</span><span class="n">c_0</span><span class="p">,</span> <span class="n">af_0</span><span class="p">,</span> <span class="n">grad_af</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

        <span class="c1"># revert tip cells</span>
        <span class="n">tip_cell_manager</span><span class="o">.</span><span class="n">revert_tip_cells</span><span class="p">(</span><span class="n">af_0</span><span class="p">,</span> <span class="n">grad_af</span><span class="p">)</span>

        <span class="c1"># move tip cells</span>
        <span class="n">tip_cell_manager</span><span class="o">.</span><span class="n">move_tip_cells</span><span class="p">(</span><span class="n">c_0</span><span class="p">,</span> <span class="n">af_0</span><span class="p">,</span> <span class="n">grad_af</span><span class="p">)</span>

        <span class="c1"># get tip cells field</span>
        <span class="n">tipcells_field</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tip_cell_manager</span><span class="o">.</span><span class="n">get_latest_tip_cell_function</span><span class="p">())</span>

        <span class="c1"># update fields</span>
        <span class="n">fenics</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">weak_form</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">jacobian</span><span class="p">)</span>

        <span class="c1"># assign u to the initial conditions functions</span>
        <span class="n">fenics</span><span class="o">.</span><span class="n">assign</span><span class="p">([</span><span class="n">af_0</span><span class="p">,</span> <span class="n">c_0</span><span class="p">,</span> <span class="n">mu_0</span><span class="p">],</span> <span class="n">u</span><span class="p">)</span>

        <span class="c1"># update source field</span>
        <span class="n">sources_manager</span><span class="o">.</span><span class="n">apply_sources</span><span class="p">(</span><span class="n">af_0</span><span class="p">)</span>

        <span class="c1"># compute grad_T</span>
        <span class="n">grad_af</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">fenics</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">fenics</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">af_0</span><span class="p">),</span> <span class="n">grad_af_function_space</span><span class="p">))</span>

        <span class="c1"># save data</span>
        <span class="n">file_af</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">af_0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">file_c</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c_0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">tipcells_xdmf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tipcells_field</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># load parameters</span>
<span class="n">parameters_file</span> <span class="o">=</span> <span class="n">file_folder</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;demo_in/angiogenesis_2d/parameters.ods&quot;</span><span class="p">)</span>
<span class="n">std_parameters</span> <span class="o">=</span> <span class="n">mpar</span><span class="o">.</span><span class="n">from_ods_sheet</span><span class="p">(</span><span class="n">parameters_file</span><span class="p">,</span> <span class="s2">&quot;SimParams&quot;</span><span class="p">)</span>

<span class="c1"># define test conditions as dict</span>
<span class="n">test_conditions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sim2C&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig2C&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 2C. The change in the &#39;chi&#39; parameter leads &quot;</span>
                <span class="s2">&quot;to a reduction of the tip cell velocity.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;chi&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;chi&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sim2D&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig2D&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 2D. The tip cell velocity is normal.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;chi&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;chi&quot;</span><span class="p">)}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sim3C&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig3C&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 3C. The proliferation rate is low.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;alpha_p&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;alpha_p&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                 <span class="s2">&quot;chi&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;chi&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.625</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sim3D&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig3D&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 3D. The proliferation rate is high.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;alpha_p&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;alpha_p&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.34</span><span class="p">,</span>
                                 <span class="s2">&quot;chi&quot;</span><span class="p">:</span> <span class="n">std_parameters</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;chi&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.625</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sim4C&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig4C&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 4C. The angiogenic factor production is low&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;T_s&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sim4D&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Travasso Fig4D&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulation reported in Travasso et al. (2011) in Figure 4D. The angiogenic factor production is high.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters_to_change&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;T_s&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># run multiple simulations</span>
<span class="k">for</span> <span class="n">sim_dict_key</span> <span class="ow">in</span> <span class="n">test_conditions</span><span class="p">:</span>
    <span class="c1"># get dictionary for simulation</span>
    <span class="n">sim_dict</span> <span class="o">=</span> <span class="n">test_conditions</span><span class="p">[</span><span class="n">sim_dict_key</span><span class="p">]</span>

    <span class="c1"># set data folder for current simulation</span>
    <span class="n">data_folder</span> <span class="o">=</span> <span class="n">mansimd</span><span class="o">.</span><span class="n">setup_data_folder</span><span class="p">(</span>
        <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;{file_folder / Path(&#39;demo_out&#39;)}/multiple_angiogenesis_simulations&quot;</span><span class="p">,</span>
        <span class="n">auto_enumerate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># load standard parameters value</span>
    <span class="n">std_parameters</span> <span class="o">=</span> <span class="n">mpar</span><span class="o">.</span><span class="n">from_ods_sheet</span><span class="p">(</span><span class="n">parameters_file</span><span class="p">,</span> <span class="s2">&quot;SimParams&quot;</span><span class="p">)</span>
    <span class="c1"># and change the parameter according to the simulation</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;parameters_to_change&quot;</span><span class="p">]:</span>
        <span class="n">std_parameters</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">param</span><span class="p">,</span>
                                 <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;parameters_to_change&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">])</span>

    <span class="c1"># run simulation measuring execution time</span>
    <span class="n">error_message</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">init_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">run_angiogenesis_simulation</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;simulating </span><span class="si">{test_conditions[sim_dict_key][&#39;name&#39;]}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">std_parameters</span><span class="p">,</span>
                                    <span class="n">data_folder</span><span class="p">)</span>
        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">init_time</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">execution_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="c1"># store simulation meta-data</span>
    <span class="n">mansimd</span><span class="o">.</span><span class="n">save_sim_info</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span>
                          <span class="n">parameters</span><span class="o">=</span><span class="n">std_parameters</span><span class="p">,</span>
                          <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
                          <span class="n">sim_name</span><span class="o">=</span><span class="n">test_conditions</span><span class="p">[</span><span class="n">sim_dict_key</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                          <span class="n">sim_description</span><span class="o">=</span><span class="n">test_conditions</span><span class="p">[</span><span class="n">sim_dict_key</span><span class="p">][</span><span class="s1">&#39;desc&#39;</span><span class="p">],</span>
                          <span class="n">error_msg</span><span class="o">=</span><span class="n">error_message</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.000 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-demo-doc-multiple-angiogenesis-simulations-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/a71dfd7199d9e760eb6b12149b9f03e9/multiple_angiogenesis_simulations.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">multiple_angiogenesis_simulations.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/65c6e47d963eb3d874485bee09ecdf0a/multiple_angiogenesis_simulations.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">multiple_angiogenesis_simulations.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="angiogenesis_3d.html" class="btn btn-neutral float-left" title="Angiogenesis 3D" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../installation.html" class="btn btn-neutral float-right" title="Installation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Franco Pradelli.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #343131;
    }
  </style>


</body>
</html>